<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Заголовок сторінки -->
    <title data-i18n="appTitle">HTML-&gt;INI Database Generator</title> 
    <!-- Підключення Tailwind CSS для стилізації -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стилі для забезпечення гарного вигляду прокрутки та моноширинного шрифту */
        textarea {
            resize: none;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* Встановлюємо основний фон */
        body {
            background-color: #f3f4f6; /* light gray background */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8"> 
    <div class="max-w-4xl mx-auto">
        
        <!-- HEADER AND CONTROLS - Сучасний дизайн -->
        <header class="text-center mb-10 bg-white p-8 rounded-2xl shadow-xl border-t-4 border-indigo-500">
            <div class="flex justify-end items-start mb-4">
                
                <!-- Language Toggle -->
                <div class="relative inline-block text-left">
                    <select id="langSelect" onchange="toggleLanguage(this.value)" class="p-2 border border-gray-300 bg-white text-gray-700 rounded-lg shadow-sm transition hover:border-indigo-500">
                        <option value="en">English</option>
                        <option value="uk">Українська</option>
                    </select>
                </div>
            </div>

            <!-- Виразний заголовок -->
            <h1 data-i18n="mainHeader" class="text-4xl font-extrabold text-gray-800 mb-2 tracking-tight">
                Database Generator <span class="text-indigo-600">(HTML &rarr; INI)</span>
            </h1>
            <p data-i18n="subheader" class="text-gray-600 text-lg">
                Paste the HTML directory listing to instantly generate INI-like database entries.
            </p>
        </header>

        <!-- Основний блок контенту -->
        <div class="bg-white p-8 rounded-2xl shadow-2xl space-y-8">
            
            <!-- Секція для вхідного HTML -->
            <div>
                <label for="htmlInput" data-i18n="labelHtmlInput" class="block text-xl font-semibold text-gray-800 mb-3">1. Paste HTML File Content:</label>
                <textarea id="htmlInput" rows="12" class="w-full p-4 border border-gray-300 bg-gray-50 text-gray-800 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-inner" data-i18n-placeholder="placeholderHtmlInput" placeholder="Paste the entire HTML page code here, containing the file list (e.g., from Myrient or Internet Archive listing)..."></textarea>
            </div>

            <!-- Кнопка обробки (тепер одна) -->
            <div class="flex justify-center">
                <button id="processButton" class="w-full max-w-sm px-8 py-4 bg-indigo-600 text-white font-extrabold rounded-xl shadow-lg shadow-indigo-500/50 hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.02] disabled:opacity-50 disabled:shadow-none" onclick="processHtml()">
                    <span data-i18n="btnGenerateDB">Generate Database</span>
                </button>
            </div>
            
            <!-- Повідомлення про статус -->
            <div id="statusMessage" class="text-center text-base font-medium h-6 text-gray-700"></div>

            <!-- Секція для вихідного INI-формату -->
            <div>
                <label for="iniOutput" data-i18n="labelIniOutput" class="block text-xl font-semibold text-gray-800 mb-3">2. Result (INI-like Format):</label>
                <textarea id="iniOutput" rows="12" readonly class="w-full p-4 bg-gray-100 text-gray-800 border border-gray-300 rounded-xl transition duration-150 shadow-inner"></textarea>
            </div>

            <!-- Кнопки копіювання/завантаження -->
            <div class="flex justify-center space-x-6 pt-4">
                <button id="copyButton" class="px-8 py-3 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition duration-200 disabled:opacity-50 shadow-md hover:shadow-lg" onclick="copyOutput()" disabled>
                    <span data-i18n="btnCopy">Copy Result</span>
                </button>
                <button id="downloadButton" class="px-8 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition duration-200 disabled:opacity-50 shadow-md hover:shadow-lg" onclick="downloadOutput()" disabled>
                    <span data-i18n="btnDownload">Download .ini</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const FORBIDDEN_CHARS = "!+";
        
        // --- APP STATE ---
        const STATE = {
            currentLang: 'en', // English by default
            database: [], // Content objects are stored here
        };
        
        // --- TRANSLATIONS ---
        const translations = {
            uk: {
                appTitle: "HTML->INI Генератор Бази Даних",
                mainHeader: "Генератор Бази Даних (HTML → INI)",
                subheader: "Вставте вміст HTML-файлу зі списком контенту (каталогу) для генерації INI-подібного формату.",
                labelHtmlInput: "1. Вставте вміст HTML-файлу:",
                placeholderHtmlInput: "Вставте сюди весь код HTML-сторінки, що містить список файлів (наприклад, з Myrient або Internet Archive)...",
                btnGenerateDB: "Згенерувати Базу Даних",
                labelIniOutput: "2. Результат (INI-подібний формат):",
                btnCopy: "Копіювати результат",
                btnDownload: "Завантажити .ini",
                statusProcessing: "Обробка...",
                statusErrorNoInput: "Будь ласка, вставте HTML-код.",
                statusErrorParsing: "Помилка обробки: Не вдалося знайти записи. Перевірте консоль.",
                statusErrorParsingStructure: "Не вдалося знайти записи про контент (посилання та розмір) у HTML-файлі. Переконайтеся, що дані містяться у структурі <tr>/<td>.",
                statusFound: (count) => `Успішно знайдено ${count} записів контенту.`,
                statusCopied: "Результат скопійовано!",
                statusDownloaded: "Файл завантажено!",
            },
            en: {
                appTitle: "HTML->INI Database Generator",
                mainHeader: "Database Generator (HTML → INI)",
                subheader: "Paste the HTML directory listing to instantly generate INI-like database entries.",
                labelHtmlInput: "1. Paste HTML File Content:",
                placeholderHtmlInput: "Paste the entire HTML page code here, containing the file list (e.g., from Myrient or Internet Archive listing)...",
                btnGenerateDB: "Generate Database",
                labelIniOutput: "2. Result (INI-like Format):",
                btnCopy: "Copy Result",
                btnDownload: "Download .ini",
                statusProcessing: "Processing...",
                statusErrorNoInput: "Please paste the HTML code.",
                statusErrorParsing: "Processing error: Could not find records. Check console.",
                statusErrorParsingStructure: "Could not find content records (links and sizes) in the HTML file. Ensure the data is contained within a <tr>/<td> structure.",
                statusFound: (count) => `Successfully found ${count} content records.`,
                statusCopied: "Result copied!",
                statusDownloaded: "File downloaded!",
            },
        };

        // --- PARSING AND GENERATION LOGIC ---

        /**
         * Cleans the filename for use as a unique INI section header.
         */
        function clean_title(title) {
            const lastDotIndex = title.lastIndexOf('.');
            const titleNoExt = (lastDotIndex > 0) ? title.substring(0, lastDotIndex) : title;
            
            const forbiddenRegex = new RegExp(`[${FORBIDDEN_CHARS.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}]`, 'g');
            let cleaned = titleNoExt.replace(forbiddenRegex, '');
            
            return cleaned.trim();
        }

        /**
         * Extracts the directory path from the download URL.
         */
        function get_dir_from_url(url) {
            try {
                const tempUrl = new URL(url, window.location.href); 
                let pathSegment = tempUrl.pathname;
                
                let pathDecoded = decodeURIComponent(pathSegment);
                
                pathDecoded = pathDecoded.startsWith('/') ? pathDecoded.substring(1) : pathDecoded;
                
                const lastSlashIndex = pathDecoded.lastIndexOf('/');
                if (lastSlashIndex === -1) {
                    return ""; 
                }
                
                return pathDecoded.substring(0, lastSlashIndex);
            } catch (e) {
                console.error("URL parsing error:", e);
                return "";
            }
        }

        /**
         * Parses HTML content and returns a list of content data objects.
         */
        function parseHtmlToDatabase(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const contentList = [];
            
            // Look for table rows
            const rows = doc.querySelectorAll('tr');

            rows.forEach(row => {
                let anchor = null;
                let itemSize = '';
                
                // 1. Find the file link (<a>) in the row
                const linkElements = row.querySelectorAll('a[href]');
                for (const link of linkElements) {
                    const linkText = link.textContent.trim();
                    // Skip parent directory links
                    if (linkText !== '..' && link.getAttribute('href') !== '..') {
                        anchor = link;
                        break;
                    }
                }
                
                if (!anchor) {
                    return; 
                }

                // 2. Find the file size. 
                const cells = row.querySelectorAll('td');
                
                // Priority 1: Myrient-style (class="size")
                const sizeCellMyrient = row.querySelector('td.size');
                if (sizeCellMyrient) {
                    itemSize = sizeCellMyrient.textContent.trim();
                }

                // Priority 2: Internet Archive / General style (search all <td> for size units)
                if (!itemSize) {
                    for (const cell of cells) {
                        const text = cell.textContent.trim();
                        // Pattern: number (with/without dot), optional space, unit (KiB, MiB, GiB, KB, MB, GB, bytes)
                        if (/\d+(\.\d+)?\s?(KiB|MiB|GiB|KB|MB|GB|bytes)/i.test(text)) {
                            itemSize = text;
                            break; 
                        }
                    }
                }
                
                // 3. If a link and size are found, add the item
                if (anchor && itemSize) {
                    const itemTitle = anchor.textContent.trim();
                    const dataUrl = anchor.href; 
                    
                    const uniqueTitle = clean_title(itemTitle);
                    const pathValue = get_dir_from_url(dataUrl);

                    contentList.push({
                        unique_title: uniqueTitle,
                        itemTitle: itemTitle,
                        itemVersion: "",
                        itemAuthor: "",
                        itemSize: itemSize,
                        path: pathValue,
                        // itemDescription field is removed
                        dataurl: dataUrl
                    });
                }
            });

            return contentList;
        }

        /**
         * Formats the database into an INI-like string.
         */
        function generateIniFormat(database) {
            const iniContent = [];
            
            database.forEach(entry => {
                iniContent.push(`\n[${entry.unique_title}]`);
                
                iniContent.push(`itemTitle=${entry.itemTitle}`);
                
                if (entry.itemVersion) {
                    iniContent.push(`itemVersion=${entry.itemVersion}`);
                }
                
                if (entry.itemAuthor) {
                    iniContent.push(`itemAuthor=${entry.itemAuthor}`);
                }

                if (entry.itemSize) {
                    iniContent.push(`itemSize=${entry.itemSize}`);
                }

                iniContent.push(`path=${entry.path}`);

                iniContent.push(`dataurl=${entry.dataurl}`);
            });

            return iniContent.join('\n');
        }

        // --- CORE APP FUNCTIONS ---

        /**
         * Main function that starts the parsing process.
         */
        function processHtml() {
            const htmlInput = document.getElementById('htmlInput').value;
            
            STATE.database = [];
            document.getElementById('iniOutput').value = '';
            
            setStatus(translations[STATE.currentLang].statusProcessing, 'text-blue-600');
            // Вмикаємо/вимикаємо кнопки лише для парсингу та дій
            setButtonsDisabled(true, true); 

            if (!htmlInput.trim()) {
                setStatus(translations[STATE.currentLang].statusErrorNoInput, 'text-red-600');
                setButtonsDisabled(false, true);
                return;
            }

            try {
                const database = parseHtmlToDatabase(htmlInput);
                STATE.database = database;
                
                if (database.length === 0) {
                    document.getElementById('iniOutput').value = translations[STATE.currentLang].statusErrorParsingStructure;
                    setStatus(translations[STATE.currentLang].statusFound(0), 'text-orange-600');
                    setButtonsDisabled(false, true);
                } else {
                    const iniResult = generateIniFormat(database);
                    document.getElementById('iniOutput').value = iniResult;
                    
                    setStatus(translations[STATE.currentLang].statusFound(database.length), 'text-green-600');

                    // Активуємо кнопки копіювання/завантаження
                    setButtonsDisabled(false, false); 
                }
            } catch (e) {
                console.error(e);
                document.getElementById('iniOutput').value = translations[STATE.currentLang].statusErrorParsing + `\n${e.message}`;
                setStatus(translations[STATE.currentLang].statusErrorParsing, 'text-red-600');
                setButtonsDisabled(false, true);
            }
        }
        
        /**
         * Sets the status message.
         */
        function setStatus(message, className) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `text-center text-base font-medium h-6 ${className}`;
        }

        /**
         * Controls the state of the buttons.
         * @param {boolean} process Disabled state for "Generate Database" button.
         * @param {boolean} actions Disabled state for copy/download buttons.
         */
        function setButtonsDisabled(process, actions) {
            document.getElementById('processButton').disabled = process;
            document.getElementById('copyButton').disabled = actions;
            document.getElementById('downloadButton').disabled = actions;
        }

        /**
         * Copies the output to the clipboard.
         */
        function copyOutput() {
            const iniOutput = document.getElementById('iniOutput');
            iniOutput.select();
            document.execCommand('copy');
            setStatus(translations[STATE.currentLang].statusCopied, 'text-green-600');
        }

        /**
         * Downloads the output as an INI file.
         */
        function downloadOutput() {
            const iniOutput = document.getElementById('iniOutput').value;
            const filename = 'submenu_database.ini';
            const blob = new Blob([iniOutput], { type: 'text/plain;charset=utf-8' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setStatus(translations[STATE.currentLang].statusDownloaded, 'text-green-600');
        }
        
        // --- LANGUAGE LOGIC ---
        
        /**
         * Updates all UI elements according to the current language.
         */
        function updateUI() {
            const lang = STATE.currentLang;
            
            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (typeof translations[lang][key] === 'function') {
                        return;
                    }
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update page title
            document.title = translations[lang].appTitle;
            document.documentElement.lang = lang;
            
            // Set the correct language selector value
            document.getElementById('langSelect').value = lang;
        }

        /**
         * Toggles the application language.
         */
        function toggleLanguage(lang) {
            STATE.currentLang = lang;
            localStorage.setItem('lang', lang);
            updateUI();
        }

        /**
         * Loads settings from localStorage on page load and detects browser language.
         */
        function loadSettings() {
            const savedLang = localStorage.getItem('lang');
            
            if (savedLang && translations[savedLang]) {
                // Пріоритет 1: Використовуємо збережену мову
                STATE.currentLang = savedLang;
            } else {
                // Пріоритет 2: Визначаємо мову браузера
                // Отримуємо базовий код мови (наприклад, 'uk-UA' -> 'uk')
                const browserLang = (navigator.language || navigator.languages[0] || 'en').substring(0, 2);
                
                if (browserLang === 'uk') {
                    STATE.currentLang = 'uk';
                } else if (browserLang === 'en') {
                    STATE.currentLang = 'en';
                } else {
                    // Пріоритет 3: Повертаємося до англійської за замовчуванням
                    STATE.currentLang = 'en'; 
                }
            }
            
            updateUI();
        }

        // Initialization on load
        window.onload = loadSettings;

    </script>
</body>
</html>